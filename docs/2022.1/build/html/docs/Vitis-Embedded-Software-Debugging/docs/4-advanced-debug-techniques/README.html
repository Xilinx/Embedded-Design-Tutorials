


<!DOCTYPE HTML>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
	<head>
		<meta charset="utf-8">
		
		<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
		<link rel="stylesheet" href="https://static.cloud.coveo.com/searchui/v2.4382/css/CoveoFullSearch.css"/>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta name="description"/>
		<meta name="keywords"/>
		<meta property="og:title" content=""/>
		<meta property="og:description"/>
		<!-- favicon -->
		<link rel="icon" type="image/vnd.microsoft.icon" href="../../../../_static/favicon.ico"/>
		<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="../../../../_static/favicon.ico"/>
		<!-- Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css"/>
	<!-- OneTrust Cookies Consent Notice start for xilinx.com -->
	<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" charset="UTF-8" data-domain-script="db4fe3da-ef3c-4524-b938-84c8062bf167"></script>
	<script type="text/javascript">
	function OptanonWrapper() { }
	</script>
	<!-- OneTrust Cookies Consent Notice end for xilinx.com -->
	
		<!-- Google Tag Manager -->
	<script type="text/plain" class="optanon-category-C0002">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-5RHQV7');</script>
	<!-- End Google Tag Manager -->
	
        <!-- Google Tag Manager -->
        <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5RHQV7" height="0" width="0" style="display:none;visibility:hidden" class="optanon-category-C0002"></iframe></noscript>
        <!-- End Google Tag Manager -->	

  
  
  
  

  
      <script type="text/javascript" src="../../../../_static/js/jquery.min.js"></script>
	  <script type="text/javascript" src="../../../../_static/js/gtm.js"></script>
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/d3dd8c60ed.js"></script>
    <script type="text/javascript" src="../../../../_static/js/common-ui-all.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/header-footer.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/linkid.js"></script>
    <script type="text/javascript" src="../../../../_static/js/Searchbox.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/Searchbox.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/common-ui-all.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/header-footer.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/pro.min.css" media="all" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Summary" href="../5-summary/README.html" />
    <link rel="prev" title="Debugging Linux Applications" href="../3-debugging-linux-applications/README.html" /> 
	</head>
	<body>
		<div class="xilinx-bs3"/>
		<div class="root responsivegrid">
			<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 aem-Grid--large--16 aem-Grid--xlarge--16 aem-Grid--xxlarge--16 aem-Grid--xxxlarge--16 ">
 <div class="xilinxExperienceFragments experiencefragment aem-GridColumn aem-GridColumn--default--12">

    
    

    



<div class="xf-content-height">
    

<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
    
    <div class="header parbase aem-GridColumn aem-GridColumn--default--12"><noindex>
	<header data-component="header" class="site-header">
		<nav class="navbar navbar-default">
			<div class="container-fluid main-nav">
				<div class="row">
					<div class="navbar-column col-xs-4 col-sm-5">
						<ul class="nav navbar-nav hidden-xs">
							<li>
									<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
								</li>
							<li>
									<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
								</li>
							<li>
									<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
								</li>
							</ul>
							
						<ul class="nav navbar-nav hidden-sm hidden-md hidden-lg">
							<li>
									<button data-target="#header-container-0" data-function="toggle">Solutions</button>
								</li>
							<li>
									<button data-target="#header-container-1" data-function="toggle">Products</button>
								</li>
							<li>
									<button data-target="#header-container-2" data-function="toggle">Company</button>
								</li>
							</ul>
							
						<div id="header-container-0" class="menu-container">
								<div class="navbar-nav-container">
									<ul class="nav navbar-nav">
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
												</li>
										</ul>
									<button data-function="close-menu">
										<span class="fal fa-times" aria-hidden="true"></span>
									</button>
								</div>
							</div>
							<div id="header-container-1" class="menu-container">
								<div class="navbar-nav-container">
									<ul class="nav navbar-nav">
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
												</li>
										</ul>
									<button data-function="close-menu">
										<span class="fal fa-times" aria-hidden="true"></span>
									</button>
								</div>
							</div>
							<div id="header-container-2" class="menu-container">
								<div class="navbar-nav-container">
									<ul class="nav navbar-nav">
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/applications.html&#39;;">Solutions</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/products/silicon-devices.html&#39;;">Products</button>
												</li>
										<li>
												<button onclick="window.location.href=&#39;https://www.xilinx.com/about/company-overview.html&#39;;">Company</button>
												</li>
										</ul>
									<button data-function="close-menu">
										<span class="fal fa-times" aria-hidden="true"></span>
									</button>
								</div>
							</div>
							</div>
					<div class="logo-column col-xs-4 col-sm-2">
						<div class="logo">
							<a href="https://www.xilinx.com/">
								<img src="https://github.com/Xilinx/Image-Collateral/blob/main/xilinx-header-logo.svg?raw=true" title="Xilinx Inc"/>
							</a>
						</div>
					</div>

				</div>
			</div>
			</nav></header></noindex></div>
		
	
</div>

    
</div>
</div>

<div class="calloutBanner parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16"><div class="callout-banner">
    Xilinx is now a part of <a href="https://www.amd.com/en/corporate/xilinx-acquisition">AMD</a> |  <a href="https://www.amd.com/en/corporate/privacy">Learn More</a>
</div>
</div>
				<div class="parsys aem-GridColumn--xxxlarge--none aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
						<div class="container-fluid">
							<div class="row">
							<div class="col-xs-12">
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> Embedded Design Tutorials
          

          
          </a>

          
            
            
              <div class="version">
                2022.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

      
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            
            
            
              
            
            
              <p class="caption"><span class="caption-text">简体中文</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Embedded-Design-Tutorials/master/docs-cn/index.html">Master</a></li>
</ul>
<p class="caption"><span class="caption-text">日本語</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Embedded-Design-Tutorials/master/docs-jp/index.html">Master</a></li>
</ul>
<p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction/Versal-EDT/Versal-EDT.html">Versal ACAP Embedded Design Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction/ZynqMPSoC-EDT/ZynqMPSoC-EDT.html">Zynq UltraScale+ MPSoC Embedded Design Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction/Zynq7000-EDT/Zynq7000-EDT.html">Zynq-7000 Embedded Design Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Feature Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Feature_Tutorials/debuggable-fsbl/debuggable-fsbl.html">First Stage Boot Loader (FSBL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Feature_Tutorials/sw-profiling/sw-profiling.html">Profiling Applications with System Debugger</a></li>
</ul>
<p class="caption"><span class="caption-text">Design Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Design_Tutorials/MPSoC_Graphic_Subsystem/README.html">Example Setup for a Graphics and DisplayPort Based Sub-System</a></li>
</ul>
<p class="caption"><span class="caption-text">Debugging</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../Debugging.html">Vitis Embedded Software Debugging Guide (UG1515) 2021.1</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../1-xilinx-debug-solution-overview/README.html">Vitis Embedded Software Debugging Guide Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../1-xilinx-debug-solution-overview/README.html#xilinx-debug-solution-overview">Xilinx Debug Solution Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2-debugging-bare-metal-applications/README.html">Debugging Bare-Metal Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3-debugging-linux-applications/README.html">Debugging Linux Applications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../3-debugging-linux-applications/README.html#appendix">Appendix</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Advanced Debug Techniques</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-the-os-aware-debug-session">Setting Up the OS Aware Debug Session</a></li>
<li class="toctree-l3"><a class="reference internal" href="#debug-view">Debug View</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#error-1-axi-gpio-application-debug">Error 1: AXI GPIO Application Debug</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vivado">Vivado</a></li>
<li class="toctree-l3"><a class="reference internal" href="#petalinux">PetaLinux</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vitis">Vitis</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#error-2-debugging-a-kernel-crash">Error 2: Debugging a Kernel Crash</a></li>
<li class="toctree-l2"><a class="reference internal" href="#error-3-debugging-a-kernel-process">Error 3: Debugging a Kernel Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="#error-4-debugging-a-kernel-module">Error 4: Debugging a Kernel Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="#error-5-debug-using-qemu">Error 5: Debug Using QEMU</a></li>
<li class="toctree-l2"><a class="reference internal" href="#further-reading">Further Reading</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#attaching-an-application-to-system-debugger">Attaching an Application to System Debugger</a></li>
<li class="toctree-l3"><a class="reference internal" href="#path-mapping">Path Mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-remote-host">Using Remote Host</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-setup-for-os-aware-debug">Basic Setup for OS Aware Debug</a></li>
<li class="toctree-l3"><a class="reference internal" href="#os-awareness-osa-options-in-the-vitis-ide">OS Awareness (OSA) Options in the Vitis IDE</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../5-summary/README.html">Summary</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">User Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../User_Guides/SPA-UG/SPA-UG.html">System Performance Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../User_Guides/Performance_Benchmark/Dhrystone/README.html">Versal Dhrystone Benchmark</a></li>
</ul>
<p class="caption"><span class="caption-text">Previous Releases</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Embedded-Design-Tutorials/docs/2021.2/build/html/index.html">2021.2</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Embedded-Design-Tutorials/docs/2021.1/build/html/index.html">2021.1</a></li>
<li class="toctree-l1"><a class="reference external" href="https://xilinx.github.io/Embedded-Design-Tutorials/docs/2020.2/docs/index.html">2020.2</a></li>
</ul>

            
			
			<p class="caption"><span class="caption-text">This Page</span></p>
				<ul class="current">
				  <li class="toctree-l1"><a href="../../../../_sources/docs/Vitis-Embedded-Software-Debugging/docs/4-advanced-debug-techniques/README.md.txt"
						rel="nofollow">Show Source</a></li>
				</ul>
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Embedded Design Tutorials</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../Debugging.html">Vitis Embedded Software Debugging Guide (UG1515) 2021.1</a> &raquo;</li>
        
      <li>Advanced Debug Techniques</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/docs/Vitis-Embedded-Software-Debugging/docs/4-advanced-debug-techniques/README.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="advanced-debug-techniques">
<h1>Advanced Debug Techniques<a class="headerlink" href="#advanced-debug-techniques" title="Permalink to this headline">¶</a></h1>
<p>This section covers the use of the Vitis™ software platform to debug a Linux kernel using the OS aware debug feature. OS aware debug over JTAG helps you to visualize the following OS-specific information, although this is not an exhaustive list:</p>
<ul class="simple">
<li><p>Processes/threads that are currently running</p></li>
<li><p>Process-/thread-specific stack trace</p></li>
<li><p>Registers</p></li>
<li><p>Variables</p></li>
</ul>
<p>To support this, the JTAG debugger identifies the OS running on the target and is aware of the intrinsics of the OS. You can debug the OS running on the processor cores and the processes/threads running on the OS simultaneously: more details are provided below. Also, if you don’t have a board in hand, you can use QEMU for debug.</p>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>To start the debug session, perform the following steps:</p>
<ol>
<li><p>Install the PetaLinux 2021.1 tool on your development environment.</p></li>
<li><p>Download the 2021.1 <a class="reference external" href="https://www.xilinx.com/member/forms/download/xef.html?filename=xilinx-zcu102-v2021.1-final.bsp">Petalinux ZCU102 BSP</a> from the Xilinx website (<code class="docutils literal notranslate"><span class="pre">xilinx-zcu102-v2021.1-final.bsp</span></code>).</p></li>
<li><p>Source the PetaLinux tool locally.</p></li>
<li><p>Run the following command: <code class="docutils literal notranslate"><span class="pre">petalinux-create</span> <span class="pre">-t</span> <span class="pre">project</span> <span class="pre">-n</span> <span class="pre">OS_debug</span> <span class="pre">-s</span> <span class="pre">xilinx-zcu102-v2021.1-final.bsp</span></code>.</p></li>
<li><p>Change the directory to <code class="docutils literal notranslate"><span class="pre">OS_debug/</span></code>.</p></li>
<li><p>Disable <code class="docutils literal notranslate"><span class="pre">cpuidle</span></code> so that the debugger works properly by editing the file <code class="docutils literal notranslate"><span class="pre">./project-spec/meta-user/recipes-bsp/device-tree/files/system-user.dtsi</span></code> with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">include</span><span class="o">/</span> <span class="s2">&quot;system-conf.dtsi&quot;</span>
<span class="o">/</span> <span class="p">{</span>
   <span class="n">chosen</span> <span class="p">{</span>
      <span class="n">bootargs</span> <span class="o">=</span> <span class="s2">&quot;earlycon clk_ignore_unused cpuidle.off=1&quot;</span><span class="p">;</span>
      <span class="n">stdout</span><span class="o">-</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;serial0:115200n8&quot;</span><span class="p">;</span>
   <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">petalinux-config</span></code>. Browse to <strong>Image Packaging Configuration &gt; INITRAMFS/INITRD Image Name</strong> and change from the existing <code class="docutils literal notranslate"><span class="pre">petalinux-initramfs-image</span></code> to <code class="docutils literal notranslate"><span class="pre">petalinux-image-minimal</span></code>. Save the modifcation and exit menuconfig. Starting from 2021.1, this change is required to load the complete rootfs post boot. For more details, refer to the “Option to Change RAM-Based Filesystem” section in the <em>PetaLinux Tools Reference Guide</em> (<a class="reference external" href="https://www.xilinx.com/cgi-bin/docs/rdoc?v=latest%3Bd=ug1144-petalinux-tools-reference-guide.pdf">UG1144</a>).</p>
<p><img alt="petalinux_config1" src="../../../../_images/petalinux_1.JPG" />
<img alt="petalinux_config2" src="../../../../_images/petalinux_2.jpg" />
<img alt="petalinux_config2" src="../../../../_images/petalinux_3.jpg" /></p>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">petalinux-build</span></code>.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">petalinux-package</span> <span class="pre">--boot</span> <span class="pre">--format</span> <span class="pre">BIN</span> <span class="pre">--fsbl</span> <span class="pre">images/linux/zynqmp_fsbl.elf</span> <span class="pre">--u-boot</span> <span class="pre">images/linux/u-boot.elf</span> <span class="pre">--fpga</span> <span class="pre">images/linux/system.bit</span> <span class="pre">--force</span></code>.</p></li>
</ol>
<p>To boot the Linux kernel, perform the following steps:</p>
<ol class="simple">
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">image.ub</span></code>, <code class="docutils literal notranslate"><span class="pre">BOOT.BIN</span></code>, and <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> to the SD card.</p></li>
<li><p>Connect the SD card to the ZCU102 board.</p></li>
<li><p>Set the UART terminal to <code class="docutils literal notranslate"><span class="pre">baudrate</span> <span class="pre">=115200</span></code> and start the board.</p></li>
</ol>
</div>
<div class="section" id="setting-up-the-os-aware-debug-session">
<h2>Setting Up the OS Aware Debug Session<a class="headerlink" href="#setting-up-the-os-aware-debug-session" title="Permalink to this headline">¶</a></h2>
<ol>
<li><p>Launch the Vitis software platform, version 2021.1. Make sure your board is connected to host PC using JTAG. If you are using a remote board, refer to the remote connection section.</p></li>
<li><p>Select <strong>Debug &gt; Debug Configurations</strong>.</p></li>
<li><p>Double-click <strong>Single Application Debug</strong> and make sure the option <strong>Attach to running target</strong> is selected for the Debug Type.</p></li>
<li><p>Click <strong>Debug</strong> to apply the debug configuration and launch the debugger.</p>
<p><img alt="debug_attach" src="../../../../_images/debug_attach.JPG" /></p>
</li>
<li><p>The debugger launches, but you will not yet see any kernel-related information. Select <strong>PSU &gt; APU &gt; Cortex-A53#0</strong>, then right-click and select <strong>Symbol Files</strong> to set the symbol files for the kernel so that the symbols and source code information are available to the Vitis IDE.</p>
<p><img alt="debug_noosa" src="../../../../_images/debug_noosa.JPG" /></p>
</li>
<li><p>In the menu, click <strong>Add</strong> and set the path to the <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code> file, which is available at <code class="docutils literal notranslate"><span class="pre">&lt;petalinux_proj_path&gt;/images/linux/vmlinux</span></code>. Select the other options as shown in the image below. Click <strong>OK</strong>, then click <strong>OK</strong> again in the Symbol Files window.</p>
<p><img alt="set_vmlinux" src="../../../../_images/vmlinux_set.jpg" /></p>
</li>
<li><p>Wait for a minute or so, and then you will be able to see the Linux option appear beneath APU.</p></li>
</ol>
<p><img alt="kernel_image_osa" src="../../../../_images/vmlinux.JPG" /></p>
</div>
<div class="section" id="debug-view">
<h2>Debug View<a class="headerlink" href="#debug-view" title="Permalink to this headline">¶</a></h2>
<p>In Debug view, you can see the kernel threads and processes that are running.</p>
<p>The top part of the view shows the kernel threads that are running on the target board:</p>
<p><img alt="kernel_image_osa" src="../../../../_images/vmlinux.JPG" /></p>
<p>The bottom part of the view shows the processes that are running on the target board: If you run a top command in the Linux kernel, you can see the process identifiers (PIDs) which match with the process view in the Vitis IDE. In the following example, the PID of uhdpc is 747, and the same can be seen in the Vitis process list.</p>
<p><img alt="top_command" src="../../../../_images/kernel_process.JPG" /></p>
</div>
</div>
<div class="section" id="error-1-axi-gpio-application-debug">
<h1>Error 1: AXI GPIO Application Debug<a class="headerlink" href="#error-1-axi-gpio-application-debug" title="Permalink to this headline">¶</a></h1>
<p>The application used here is a sample GPIO userspace application which uses <code class="docutils literal notranslate"><span class="pre">sysfs</span></code> calls to manage the on-board LED on ZCU102. The design uses an AXI GPIO connected to the 8-bit LEDs on the ZCU102 board.</p>
<p><strong>Note:</strong> The PetaLinux project must be rebuilt for this example.</p>
<p>The Vivado example design, shown in the following figure, has an AXI GPIO connected to the Zynq UltraScale+ MPSoC Processor Configuration IP. The AXI GPIO is further connected to the on-board 8-bit LED available on the ZCU102 board (GPIO_LED[7-0]: DS38, DS37, DS39, DS40, DS41, DS42, DS43, DS44). Refer to callout 21 in the ZCU102 Evaluation Board Components figure in the <em>ZCU102 Evaluation Board User Guide</em> (<a class="reference external" href="https://www.xilinx.com/support/documentation/boards_and_kits/zcu102/ug1182-zcu102-eval-bd.pdf">UG1182</a>) for the location of the LEDs on the board.</p>
<p><img alt="design" src="../../../../_images/vivado_des.JPG" /></p>
<div class="section" id="vivado">
<h2>Vivado<a class="headerlink" href="#vivado" title="Permalink to this headline">¶</a></h2>
<p>In Vivado, source the <code class="docutils literal notranslate"><span class="pre">Vivado.tcl</span></code> file which generates the block design and runs through the synthesis, implementation, and device image generation processes automatically. This completes the generation of the required hardware for building the software artifacts.</p>
<ol>
<li><p>Source <code class="docutils literal notranslate"><span class="pre">settings.sh</span></code> for Vivado 2021.1. To create the project, browse to the scripts folder and run the following from the command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vivado</span> <span class="o">-</span><span class="n">source</span> <span class="n">vivado</span><span class="o">.</span><span class="n">tcl</span>
</pre></div>
</div>
</li>
<li><p>The Vivado project will be built in the <code class="docutils literal notranslate"><span class="pre">Hardware</span></code> directory. Wait until the “Device Image Generation successfully completed” message appears, then click <strong>Open Implemented Design</strong>.</p></li>
<li><p>You can export the XSA to the <code class="docutils literal notranslate"><span class="pre">Hardware</span></code> folder using the following Tcl command:</p>
<p><code class="docutils literal notranslate"><span class="pre">write_hw_platform</span> <span class="pre">-fixed</span> <span class="pre">-include_bit</span> <span class="pre">-force</span> <span class="pre">-file</span> <span class="pre">../Hardware/mpsoc_preset_wrapper.xsa</span></code></p>
</li>
</ol>
</div>
<div class="section" id="petalinux">
<h2>PetaLinux<a class="headerlink" href="#petalinux" title="Permalink to this headline">¶</a></h2>
<p>In PetaLinux, import the custom hardware generated from Vivado on top of the ZCU102 BSP. After the project build is completed, you should have the kernel image and the required root file system to load Linux on the ZCU102 board.</p>
<p>Perform the following steps using PetaLinux 2021.1.</p>
<ol>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">petalinux-create</span> <span class="pre">-t</span> <span class="pre">project</span> <span class="pre">-n</span> <span class="pre">gpio_project</span> <span class="pre">-s</span> <span class="pre">xilinx-zcu102-v2021.1-final.bsp</span></code>.</p></li>
<li><p>Change the directory to <code class="docutils literal notranslate"><span class="pre">gpio_project/</span></code>.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">petalinux-config</span> <span class="pre">--get-hw-description=./Hardware</span></code>(point to the folder where the <code class="docutils literal notranslate"><span class="pre">mpsoc_preset_wrapper.xsa</span></code> file is present).</p></li>
<li><p>Disable <code class="docutils literal notranslate"><span class="pre">cpuidle</span></code> so that the debugger works properly by edit the file <code class="docutils literal notranslate"><span class="pre">./project-spec/meta-user/recipes-bsp/device-tree/files/system-user.dtsi</span></code> with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">include</span><span class="o">/</span> <span class="s2">&quot;system-conf.dtsi&quot;</span>
<span class="o">/</span> <span class="p">{</span>
   <span class="n">chosen</span> <span class="p">{</span>
      <span class="n">bootargs</span> <span class="o">=</span> <span class="s2">&quot;earlycon clk_ignore_unused cpuidle.off=1&quot;</span><span class="p">;</span>
      <span class="n">stdout</span><span class="o">-</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;serial0:115200n8&quot;</span><span class="p">;</span>
   <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">petalinux-config</span></code>. Browse to <strong>Image Packaging Configuration &gt; INITRAMFS/INITRD Image Name</strong> and change from the existing <code class="docutils literal notranslate"><span class="pre">petalinux-initramfs-image</span></code> to <code class="docutils literal notranslate"><span class="pre">petalinux-image-minimal</span></code>. Save the modifcation and exit menuconfig.</p>
<p><img alt="petalinux_config1" src="../../../../_images/petalinux_1.JPG" />
<img alt="petalinux_config2" src="../../../../_images/petalinux_2.jpg" />
<img alt="petalinux_config2" src="../../../../_images/petalinux_3.jpg" /></p>
</li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">petalinux-build</span></code>.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">petalinux-package</span> <span class="pre">--boot</span> <span class="pre">--format</span> <span class="pre">BIN</span> <span class="pre">--fsbl</span> <span class="pre">images/linux/zynqmp_fsbl.elf</span> <span class="pre">--u-boot</span> <span class="pre">images/linux/u-boot.elf</span> <span class="pre">--fpga</span> <span class="pre">images/linux/system.bit</span> <span class="pre">--force</span></code>.</p></li>
</ol>
</div>
<div class="section" id="vitis">
<h2>Vitis<a class="headerlink" href="#vitis" title="Permalink to this headline">¶</a></h2>
<p>In the Vitis IDE, import the custom hardware generated from Vivado to build your Linux userspace application which will be executed after loading Linux. The userspace application uses SysFS calls to the GPIO driver and is used to toggle the ZCU102 on-board LEDs connected to the AXI GPIO IP.</p>
<ol>
<li><p>Source <code class="docutils literal notranslate"><span class="pre">settings.sh</span></code> for Vitis 2021.1 or launch an XSCT instance. Enter the <code class="docutils literal notranslate"><span class="pre">scripts</span></code> directory, and from the command line run the following:</p>
<p><code class="docutils literal notranslate"><span class="pre">xsct</span> <span class="pre">vitis.tcl</span></code></p>
<p>The Vitis workspace will be created in the <code class="docutils literal notranslate"><span class="pre">scripts</span></code> folder in a folder with the same name as you have specified for your workspace.  Launch the  Vitis IDE and select the workspace to open the working directory.</p>
</li>
<li><p>Copy the <code class="docutils literal notranslate"><span class="pre">testapp_a53.elf</span></code> application over to the SD card along with the ZCU102 Linux images, and boot the board.</p></li>
<li><p>Set up OS aware debug (<a class="reference external" href="#setting-up-the-os-aware-debug-session">see above</a>) in the Vitis workspace you have built. Set the path map to point to the compiled <code class="docutils literal notranslate"><span class="pre">testapp_a53.elf</span></code> executable on your local system.</p>
<p><img alt="pathmap" src="../../../../_images/testapp_a53_pathmap.JPG" /></p>
</li>
<li><p>Mount the SD card, copy the ELF to the Linux file system, and execute the application. You will notice that the LED DS38 is not on.</p></li>
<li><p>To debug this issue, set a breakpoint in the application <code class="docutils literal notranslate"><span class="pre">main()</span></code> function in the workspace as shown below.</p>
<p><img alt="gpio_brkpoint" src="../../../../_images/set_brkpoint_gpio.jpg" /></p>
</li>
<li><p>Relaunch the application <code class="docutils literal notranslate"><span class="pre">testapp_a53.elf</span></code>. It should hit the breakpoint.</p>
<p><img alt="hit_brkpoint" src="../../../../_images/breakpoint_hit_gpio.JPG" /></p>
</li>
<li><p>Run to line 66 of the <code class="docutils literal notranslate"><span class="pre">gpio_main.c</span></code> file.</p>
<p><img alt="runtoline" src="../../../../_images/runtoline.JPG" /></p>
</li>
<li><p>Use the Memory viewer to see what went wrong. Go to the XSCT console and enter the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xsct</span><span class="o">%</span> <span class="n">targets</span>
<span class="n">xsct</span><span class="o">%</span> <span class="n">targets</span> <span class="mi">5</span> <span class="o">&lt;-</span> <span class="n">this</span> <span class="n">should</span> <span class="n">point</span> <span class="n">to</span> <span class="n">the</span> <span class="n">PSU</span> <span class="n">instance</span> <span class="kn">from</span> <span class="nn">targets</span>
<span class="n">xsct</span><span class="o">%</span> <span class="n">memmap</span> <span class="o">-</span><span class="n">addr</span> <span class="mh">0xa0000000</span> <span class="o">-</span><span class="n">size</span> <span class="mh">0x10</span> <span class="o">&lt;-</span> <span class="mh">0xa0000000</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">AXI</span> <span class="n">GPIO</span>
</pre></div>
</div>
<p><img alt="xsct" src="../../../../_images/xsct.JPG" /></p>
</li>
<li><p>Select <strong>PSU</strong> in the Memory viewer add the address for the AXI GPIO base register: 0xA0000000.</p>
<p><img alt="direction" src="../../../../_images/memory_view_not_working.JPG" /></p>
<p>Refer to the AXI GPIO register address:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mh">0xA0000000</span> <span class="o">=</span> <span class="n">GPIO_DATA</span> <span class="o">=</span> <span class="mh">0x00000000</span>
<span class="mh">0xA0000004</span> <span class="o">=</span> <span class="n">GPIO_TRI_STATE</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>
</pre></div>
</div>
<p>So, the LED is not glowing because by default the GPIO direction is set to input.</p>
<p><img alt="tristate" src="../../../../_images/axi_gpio_tri.JPG" /></p>
<p>This is happening because the direction is incorrectly set to input in the C code.</p>
</li>
<li><p>Modify the C code to set the direction to output from input:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">write</span><span class="p">(</span><span class="n">directionfd</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Rebuild the application and copy the updated one to the SD card. Repeat the steps above.</p></li>
<li><p>In the Memory viewer, the value of register 0xA0000000 toggles between 0x0 and 0x1. You should see that the LED DS38 has started to glow.</p></li>
</ol>
<p><img alt="logic 1" src="../../../../_images/memory_view_working_1.JPG" /></p>
<p><img alt="logic 0" src="../../../../_images/memory_view_working_0.JPG" /></p>
<p>For more details about the AXI GPIO node, refer to <a class="reference external" href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841846/AXI+GPIO">this page</a> on the Xilinx wiki (specifically, the section about SysFS usage).</p>
<p><strong>Note:</strong> There is a known issue that the register 0XA0000004 value would not update in the Memory viewer. To check the direction, manually enter the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@xilinx</span><span class="o">-</span><span class="n">zcu102</span><span class="o">-</span><span class="mi">2021_1</span><span class="p">:</span><span class="o">~</span><span class="c1"># cat /sys/class/gpio/gpio500/direction </span>
<span class="n">out</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="error-2-debugging-a-kernel-crash">
<h1>Error 2: Debugging a Kernel Crash<a class="headerlink" href="#error-2-debugging-a-kernel-crash" title="Permalink to this headline">¶</a></h1>
<p><strong>Disclaimer:</strong> This example is intended solely to demonstrate kernel-level debugging in the Vitis IDE.</p>
<ol>
<li><p>Copy over the <code class="docutils literal notranslate"><span class="pre">BOOT.BIN</span></code>, <code class="docutils literal notranslate"><span class="pre">image.ub</span></code>, and <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> from <code class="docutils literal notranslate"><span class="pre">bootimages/Error_1_Kernel_Crash/</span></code> to the ZCU102 SD card and boot the board.</p></li>
<li><p>The boot should stop after a crash (see the following example).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>    <span class="mf">7.128821</span><span class="p">]</span> <span class="n">user</span> <span class="n">pgtable</span><span class="p">:</span> <span class="mi">4</span><span class="n">k</span> <span class="n">pages</span><span class="p">,</span> <span class="mi">48</span><span class="o">-</span><span class="n">bit</span> <span class="n">VAs</span><span class="p">,</span> <span class="n">pgdp</span><span class="o">=</span><span class="mi">000000087</span><span class="n">a082000</span>
<span class="p">[</span>    <span class="mf">7.135259</span><span class="p">]</span> <span class="p">[</span><span class="mi">0000000000000000</span><span class="p">]</span> <span class="n">pgd</span><span class="o">=</span><span class="mi">0000000000000000</span>
<span class="p">[</span>    <span class="mf">7.137519</span><span class="p">]</span> <span class="n">usb</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">new</span> <span class="n">SuperSpeed</span> <span class="n">Gen</span> <span class="mi">1</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">number</span> <span class="mi">2</span> <span class="n">using</span> <span class="n">xhci</span><span class="o">-</span><span class="n">hcd</span>
<span class="p">[</span>    <span class="mf">7.140130</span><span class="p">]</span> <span class="n">Internal</span> <span class="n">error</span><span class="p">:</span> <span class="n">Oops</span><span class="p">:</span> <span class="mi">96000044</span> <span class="p">[</span><span class="c1">#1] SMP</span>
<span class="p">[</span>    <span class="mf">7.152025</span><span class="p">]</span> <span class="n">Modules</span> <span class="n">linked</span> <span class="ow">in</span><span class="p">:</span>
<span class="p">[</span>    <span class="mf">7.155074</span><span class="p">]</span> <span class="n">CPU</span><span class="p">:</span> <span class="mi">1</span> <span class="n">PID</span><span class="p">:</span> <span class="mi">143</span> <span class="n">Comm</span><span class="p">:</span> <span class="n">kworker</span><span class="o">/</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span> <span class="n">Not</span> <span class="n">tainted</span> <span class="mf">5.4.0</span><span class="o">-</span><span class="n">xilinx</span><span class="o">-</span><span class="n">v2020</span><span class="mf">.2</span> <span class="c1">#1</span>
<span class="p">[</span>    <span class="mf">7.162548</span><span class="p">]</span> <span class="n">Hardware</span> <span class="n">name</span><span class="p">:</span> <span class="n">ZynqMP</span> <span class="n">ZCU102</span> <span class="n">Rev1</span><span class="mf">.0</span> <span class="p">(</span><span class="n">DT</span><span class="p">)</span>
<span class="p">[</span>    <span class="mf">7.167512</span><span class="p">]</span> <span class="n">Workqueue</span><span class="p">:</span> <span class="n">events</span> <span class="n">deferred_probe_work_func</span>
<span class="p">[</span>    <span class="mf">7.172643</span><span class="p">]</span> <span class="n">pstate</span><span class="p">:</span> <span class="mi">20000005</span> <span class="p">(</span><span class="n">nzCv</span> <span class="n">daif</span> <span class="o">-</span><span class="n">PAN</span> <span class="o">-</span><span class="n">UAO</span><span class="p">)</span>
<span class="p">[</span>    <span class="mf">7.177429</span><span class="p">]</span> <span class="n">pc</span> <span class="p">:</span> <span class="n">sdhci_arasan_probe</span><span class="o">+</span><span class="mh">0x44</span><span class="o">/</span><span class="mh">0x828</span>
<span class="p">[</span>    <span class="mf">7.181862</span><span class="p">]</span> <span class="n">lr</span> <span class="p">:</span> <span class="n">platform_drv_probe</span><span class="o">+</span><span class="mh">0x50</span><span class="o">/</span><span class="mh">0xa0</span>
<span class="p">[</span>    <span class="mf">7.186209</span><span class="p">]</span> <span class="n">sp</span> <span class="p">:</span> <span class="n">ffff8000124b3ae0</span>
<span class="p">[</span>    <span class="mf">7.189507</span><span class="p">]</span> <span class="n">x29</span><span class="p">:</span> <span class="n">ffff8000124b3ae0</span> <span class="n">x28</span><span class="p">:</span> <span class="n">ffff00087a98cf00</span> 
<span class="p">[</span>    <span class="mf">7.194812</span><span class="p">]</span> <span class="n">x27</span><span class="p">:</span> <span class="n">ffff00087f7eab60</span> <span class="n">x26</span><span class="p">:</span> <span class="mi">0000000000000000</span> 
<span class="p">[</span>    <span class="mf">7.200116</span><span class="p">]</span> <span class="n">x25</span><span class="p">:</span> <span class="n">ffff800010d8a000</span> <span class="n">x24</span><span class="p">:</span> <span class="n">ffff00087a135040</span> 
<span class="p">[</span>    <span class="mf">7.205420</span><span class="p">]</span> <span class="n">x23</span><span class="p">:</span> <span class="n">ffff80001114ee10</span> <span class="n">x22</span><span class="p">:</span> <span class="mi">0000000000000000</span> 
<span class="p">[</span>    <span class="mf">7.210724</span><span class="p">]</span> <span class="n">x21</span><span class="p">:</span> <span class="n">ffff00087ab75000</span> <span class="n">x20</span><span class="p">:</span> <span class="n">ffff00087ab75010</span> 
<span class="p">[</span>    <span class="mf">7.216028</span><span class="p">]</span> <span class="n">x19</span><span class="p">:</span> <span class="mi">0000000000000000</span> <span class="n">x18</span><span class="p">:</span> <span class="mi">0000000000000001</span> 
<span class="p">[</span>    <span class="mf">7.221332</span><span class="p">]</span> <span class="n">x17</span><span class="p">:</span> <span class="n">ffff00087a81df88</span> <span class="n">x16</span><span class="p">:</span> <span class="mi">0000000008</span><span class="n">d9ee20</span> 
<span class="p">[</span>    <span class="mf">7.226636</span><span class="p">]</span> <span class="n">x15</span><span class="p">:</span> <span class="n">ffff00087a135468</span> <span class="n">x14</span><span class="p">:</span> <span class="n">ffffffffffffffff</span> 
<span class="p">[</span>    <span class="mf">7.231940</span><span class="p">]</span> <span class="n">x13</span><span class="p">:</span> <span class="n">ffff000877eade8a</span> <span class="n">x12</span><span class="p">:</span> <span class="mi">0000000000000030</span> 
<span class="p">[</span>    <span class="mf">7.237244</span><span class="p">]</span> <span class="n">x11</span><span class="p">:</span> <span class="mi">0000000000000020</span> <span class="n">x10</span><span class="p">:</span> <span class="mi">0101010101010101</span> 
<span class="p">[</span>    <span class="mf">7.242548</span><span class="p">]</span> <span class="n">x9</span> <span class="p">:</span> <span class="mi">0000000000000000</span> <span class="n">x8</span> <span class="p">:</span> <span class="n">ffff000877ea9700</span> 
<span class="p">[</span>    <span class="mf">7.247852</span><span class="p">]</span> <span class="n">x7</span> <span class="p">:</span> <span class="mi">0000000000000000</span> <span class="n">x6</span> <span class="p">:</span> <span class="mi">00000001</span><span class="n">aa251ab1</span> 
<span class="p">[</span>    <span class="mf">7.253156</span><span class="p">]</span> <span class="n">x5</span> <span class="p">:</span> <span class="mi">00</span><span class="n">ffffffffffffff</span> <span class="n">x4</span> <span class="p">:</span> <span class="mi">0000000000000000</span> 
<span class="p">[</span>    <span class="mf">7.258135</span><span class="p">]</span> <span class="n">usb</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">New</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">found</span><span class="p">,</span> <span class="n">idVendor</span><span class="o">=</span><span class="mi">054</span><span class="n">c</span><span class="p">,</span> <span class="n">idProduct</span><span class="o">=</span><span class="mi">09</span><span class="n">c2</span><span class="p">,</span> <span class="n">bcdDevice</span><span class="o">=</span> <span class="mf">1.00</span>
<span class="p">[</span>    <span class="mf">7.258462</span><span class="p">]</span> <span class="n">x3</span> <span class="p">:</span> <span class="n">ffff00087a135040</span> <span class="n">x2</span> <span class="p">:</span> <span class="mi">0000000000000000</span> 
<span class="p">[</span>    <span class="mf">7.266638</span><span class="p">]</span> <span class="n">usb</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">New</span> <span class="n">USB</span> <span class="n">device</span> <span class="n">strings</span><span class="p">:</span> <span class="n">Mfr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Product</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">SerialNumber</span><span class="o">=</span><span class="mi">3</span>
<span class="p">[</span>    <span class="mf">7.271924</span><span class="p">]</span> <span class="n">x1</span> <span class="p">:</span> <span class="n">ffff800010d8a828</span> <span class="n">x0</span> <span class="p">:</span> <span class="mi">0000000000000000</span> 
<span class="p">[</span>    <span class="mf">7.271930</span><span class="p">]</span> <span class="n">Call</span> <span class="n">trace</span><span class="p">:</span>
<span class="p">[</span>    <span class="mf">7.279061</span><span class="p">]</span> <span class="n">usb</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Product</span><span class="p">:</span> <span class="n">Storage</span> <span class="n">Media</span>
<span class="p">[</span>    <span class="mf">7.284358</span><span class="p">]</span>  <span class="n">sdhci_arasan_probe</span><span class="o">+</span><span class="mh">0x44</span><span class="o">/</span><span class="mh">0x828</span>
<span class="p">[</span>    <span class="mf">7.284363</span><span class="p">]</span>  <span class="n">platform_drv_probe</span><span class="o">+</span><span class="mh">0x50</span><span class="o">/</span><span class="mh">0xa0</span>
<span class="p">[</span>    <span class="mf">7.286801</span><span class="p">]</span> <span class="n">usb</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Manufacturer</span><span class="p">:</span> <span class="n">Sony</span>
<span class="p">[</span>    <span class="mf">7.290964</span><span class="p">]</span>  <span class="n">really_probe</span><span class="o">+</span><span class="mh">0xd8</span><span class="o">/</span><span class="mh">0x2f8</span>
<span class="p">[</span>    <span class="mf">7.290968</span><span class="p">]</span>  <span class="n">driver_probe_device</span><span class="o">+</span><span class="mh">0x54</span><span class="o">/</span><span class="mh">0xe8</span>
<span class="p">[</span>    <span class="mf">7.295058</span><span class="p">]</span> <span class="n">usb</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">SerialNumber</span><span class="p">:</span> <span class="mi">5</span><span class="n">C07104BE28715C291</span>
<span class="p">[</span>    <span class="mf">7.299044</span><span class="p">]</span>  <span class="n">__device_attach_driver</span><span class="o">+</span><span class="mh">0x80</span><span class="o">/</span><span class="mh">0xb8</span>
<span class="p">[</span>    <span class="mf">7.299048</span><span class="p">]</span>  <span class="n">bus_for_each_drv</span><span class="o">+</span><span class="mh">0x74</span><span class="o">/</span><span class="mh">0xc0</span>
<span class="p">[</span>    <span class="mf">7.299054</span><span class="p">]</span>  <span class="n">__device_attach</span><span class="o">+</span><span class="mh">0xdc</span><span class="o">/</span><span class="mh">0x138</span>
<span class="p">[</span>    <span class="mf">7.304692</span><span class="p">]</span> <span class="n">usb</span><span class="o">-</span><span class="n">storage</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mf">1.0</span><span class="p">:</span> <span class="n">USB</span> <span class="n">Mass</span> <span class="n">Storage</span> <span class="n">device</span> <span class="n">detected</span>
<span class="p">[</span>    <span class="mf">7.306431</span><span class="p">]</span>  <span class="n">device_initial_probe</span><span class="o">+</span><span class="mh">0x10</span><span class="o">/</span><span class="mh">0x18</span>
<span class="p">[</span>    <span class="mf">7.306435</span><span class="p">]</span>  <span class="n">bus_probe_device</span><span class="o">+</span><span class="mh">0x90</span><span class="o">/</span><span class="mh">0x98</span>
<span class="p">[</span>    <span class="mf">7.306439</span><span class="p">]</span>  <span class="n">deferred_probe_work_func</span><span class="o">+</span><span class="mh">0x6c</span><span class="o">/</span><span class="mh">0xa0</span>
<span class="p">[</span>    <span class="mf">7.306446</span><span class="p">]</span>  <span class="n">process_one_work</span><span class="o">+</span><span class="mh">0x1c4</span><span class="o">/</span><span class="mh">0x338</span>
<span class="p">[</span>    <span class="mf">7.310742</span><span class="p">]</span> <span class="n">scsi</span> <span class="n">host2</span><span class="p">:</span> <span class="n">usb</span><span class="o">-</span><span class="n">storage</span> <span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mf">1.0</span>
<span class="p">[</span>    <span class="mf">7.315564</span><span class="p">]</span>  <span class="n">worker_thread</span><span class="o">+</span><span class="mh">0x260</span><span class="o">/</span><span class="mh">0x488</span>
<span class="p">[</span>    <span class="mf">7.315569</span><span class="p">]</span>  <span class="n">kthread</span><span class="o">+</span><span class="mh">0x120</span><span class="o">/</span><span class="mh">0x128</span>
<span class="p">[</span>    <span class="mf">7.315573</span><span class="p">]</span>  <span class="n">ret_from_fork</span><span class="o">+</span><span class="mh">0x10</span><span class="o">/</span><span class="mh">0x18</span>
<span class="p">[</span>    <span class="mf">7.315580</span><span class="p">]</span> <span class="n">Code</span><span class="p">:</span> <span class="n">f90067e2</span> <span class="n">d2800002</span> <span class="n">f90033e1</span> <span class="n">f94146bb</span> <span class="p">(</span><span class="n">b900001f</span><span class="p">)</span> 
<span class="p">[</span>    <span class="mf">7.370880</span><span class="p">]</span> <span class="o">---</span><span class="p">[</span> <span class="n">end</span> <span class="n">trace</span> <span class="mi">7</span><span class="n">a82e0978c685cff</span> <span class="p">]</span><span class="o">---</span>
<span class="p">[</span>    <span class="mf">7.805494</span><span class="p">]</span> <span class="p">[</span><span class="n">drm</span><span class="p">]</span> <span class="n">Cannot</span> <span class="n">find</span> <span class="nb">any</span> <span class="n">crtc</span> <span class="ow">or</span> <span class="n">sizes</span>
<span class="p">[</span>    <span class="mf">8.389808</span><span class="p">]</span> <span class="n">scsi</span> <span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">Direct</span><span class="o">-</span><span class="n">Access</span>     <span class="n">Sony</span>     <span class="n">Storage</span> <span class="n">Media</span>    <span class="n">PMAP</span> <span class="n">PQ</span><span class="p">:</span> <span class="mi">0</span> <span class="n">ANSI</span><span class="p">:</span> <span class="mi">6</span>
<span class="p">[</span>    <span class="mf">9.483269</span><span class="p">]</span> <span class="n">sd</span> <span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="mi">15199296</span> <span class="mi">512</span><span class="o">-</span><span class="n">byte</span> <span class="n">logical</span> <span class="n">blocks</span><span class="p">:</span> <span class="p">(</span><span class="mf">7.78</span> <span class="n">GB</span><span class="o">/</span><span class="mf">7.25</span> <span class="n">GiB</span><span class="p">)</span>
<span class="p">[</span>    <span class="mf">9.491954</span><span class="p">]</span> <span class="n">sd</span> <span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="n">Write</span> <span class="n">Protect</span> <span class="ow">is</span> <span class="n">off</span>
<span class="p">[</span>    <span class="mf">9.496748</span><span class="p">]</span> <span class="n">sd</span> <span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="n">Mode</span> <span class="n">Sense</span><span class="p">:</span> <span class="mi">23</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>
<span class="p">[</span>    <span class="mf">9.502874</span><span class="p">]</span> <span class="n">sd</span> <span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="n">No</span> <span class="n">Caching</span> <span class="n">mode</span> <span class="n">page</span> <span class="n">found</span>
<span class="p">[</span>    <span class="mf">9.508190</span><span class="p">]</span> <span class="n">sd</span> <span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="n">Assuming</span> <span class="n">drive</span> <span class="n">cache</span><span class="p">:</span> <span class="n">write</span> <span class="n">through</span>
<span class="p">[</span>    <span class="mf">9.541220</span><span class="p">]</span>  <span class="n">sda</span><span class="p">:</span> <span class="n">sda1</span>
<span class="p">[</span>    <span class="mf">9.547109</span><span class="p">]</span> <span class="n">sd</span> <span class="mi">2</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="n">sda</span><span class="p">]</span> <span class="n">Attached</span> <span class="n">SCSI</span> <span class="n">removable</span> <span class="n">disk</span>
</pre></div>
</div>
</li>
<li><p>Set up the OS aware debug session by attaching to the running target. Load the attached symbol file, <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code>, for the ZCU102 board. The <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code> file should already have been generated as part of the steps outlined in <a class="reference external" href="#getting-started">Getting Started</a>.</p></li>
<li><p>In the Vitis IDE, add a breakpoint at the function <code class="docutils literal notranslate"><span class="pre">start_kernel</span></code>.</p>
<p><img alt="breakpoint_1" src="../../../../_images/start_kernel.PNG" /></p>
</li>
<li><p>Restart the board and wait for the breakpoint to be hit.</p></li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">step</span></code> function to move over the driver code and you will notice a bug related to a null pointer dereference. As can be seen in the crash, the issue seems to be with the probe function of the SDHCI driver code. The code can be reviewed <a class="reference external" href="https://github.com/Xilinx/linux-xlnx/blob/master/drivers/mmc/host/sdhci-of-arasan.c">here</a>.</p></li>
<li><p>When the driver is updated, the boot should work without issue.</p></li>
</ol>
<p><strong>Note:</strong> The default ZCU102 pre-built image will not have this error.</p>
</div>
<div class="section" id="error-3-debugging-a-kernel-process">
<h1>Error 3: Debugging a Kernel Process<a class="headerlink" href="#error-3-debugging-a-kernel-process" title="Permalink to this headline">¶</a></h1>
<p>This section demonstrates how to debug a kernel process using the Vitis IDE. First, you need to complete the steps explained in <a class="reference external" href="#setting-up-the-os-aware-debug-session">Setting Up the OS Aware Debug Session</a>. You also need to ensure that you have PetaLinux set up as described in <a class="reference external" href="#getting-started">Getting Started</a>.</p>
<p>The next step focuses on the <code class="docutils literal notranslate"><span class="pre">dropbear</span></code> process. For more details about Dropbear, refer to <a class="reference external" href="https://matt.ucc.asn.au/dropbear/dropbear.html">this website</a>. By default, PetaLinux enables Dropbear while compiling the root file system, and then deletes the intermediate source files. These files are required for debugging <code class="docutils literal notranslate"><span class="pre">dropbear</span></code> or any other processes compiled by PetaLinux (e<code class="docutils literal notranslate"><span class="pre">x-</span> <span class="pre">udev</span></code>, <code class="docutils literal notranslate"><span class="pre">tcf-agent</span></code>, and so on). Perform the following steps to make sure that the source/symbols are <em>not</em> deleted by the PetaLinux build.</p>
<ol>
<li><p>Run the command <code class="docutils literal notranslate"><span class="pre">petalinux-build</span> <span class="pre">-c</span> <span class="pre">dropbear</span> <span class="pre">-x</span> <span class="pre">compile</span> <span class="pre">-f</span></code>. The files will be available at: <code class="docutils literal notranslate"><span class="pre">&lt;petalinux_proj_path&gt;/build/tmp/work/cortexa72-cortexa53-xilinx-linux/dropbear/2020.80-r0/build</span></code>. The executable is <code class="docutils literal notranslate"><span class="pre">dropbearmulti</span></code>.</p></li>
<li><p>The next step is to set up the Linux OS aware debug session, but remember to set the path map for <code class="docutils literal notranslate"><span class="pre">dropbearmulti</span></code> before you do this.</p></li>
<li><p>Open <strong>Debug Configurations</strong> and add the path map to point to the <code class="docutils literal notranslate"><span class="pre">dropbearmulti</span></code> source files.</p>
<p><img alt="dropbear" src="../../../../_images/dropbear_pathmap.JPG" /></p>
</li>
<li><p>Launch the debug configuration and enable OS aware debug by setting the <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code> symbol files.</p></li>
<li><p>Notice the PID of the <code class="docutils literal notranslate"><span class="pre">dropbear</span></code> in the Vitis IDE. Select the process, right-click it, and select <strong>Suspend</strong>.</p>
<p><img alt="dropbear_1" src="../../../../_images/dropbear_osa.JPG" /></p>
</li>
<li><p>Locate the source file, <code class="docutils literal notranslate"><span class="pre">svr-main.c</span></code>, which can be found at <code class="docutils literal notranslate"><span class="pre">&lt;petalinux_proj_path&gt;/build/tmp/work/cortexa72-cortexa53-xilinx-linux/dropbear/2020.80-r0/dropbear-2020.80/svr-main.c</span></code>.</p>
<p><img alt="dropbear_2" src="../../../../_images/dropbear_suspend.JPG" /></p>
</li>
<li><p>In line 114, notice function <code class="docutils literal notranslate"><span class="pre">main_noinetd()</span></code>. Add a breakpoint in the Vitis IDE, as illustrated in the following figure.</p>
<p><img alt="dropbear_3" src="../../../../_images/dropbear_brkpoint.PNG" /></p>
</li>
<li><p>Resume the <code class="docutils literal notranslate"><span class="pre">dropbear</span></code> process by selecting it the Vitis IDE and pressing <strong>F8</strong>.</p></li>
<li><p>Stop the <code class="docutils literal notranslate"><span class="pre">dropbear</span></code> process and then restart it to see if the breakpoint can be hit.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@xilinx</span><span class="o">-</span><span class="n">zcu102</span><span class="o">-</span><span class="mi">2021_1</span><span class="p">:</span><span class="o">~</span><span class="c1"># /etc/init.d/dropbear stop  </span>
<span class="n">Stopping</span> <span class="n">Dropbear</span> <span class="n">SSH</span> <span class="n">server</span><span class="p">:</span> <span class="n">stopped</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">dropbear</span> <span class="p">(</span><span class="n">pid</span> <span class="mi">758</span><span class="p">)</span>
<span class="n">dropbear</span><span class="o">.</span>
<span class="n">root</span><span class="nd">@xilinx</span><span class="o">-</span><span class="n">zcu102</span><span class="o">-</span><span class="mi">2021_1</span><span class="p">:</span><span class="o">~</span><span class="c1"># /etc/init.d/dropbear start</span>
<span class="n">Starting</span> <span class="n">Dropbear</span> <span class="n">SSH</span> <span class="n">server</span><span class="p">:</span> <span class="n">dropbear</span>
</pre></div>
</div>
</li>
<li><p>The breakpoint has been hit at <code class="docutils literal notranslate"><span class="pre">main_noinetd()</span></code>.</p></li>
</ol>
<p><img alt="dropbear_4" src="../../../../_images/dropbear_hit_brkpoint.JPG" /></p>
<ol class="simple">
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">step</span></code> functions to browse over the code and debug if you see any issues.</p></li>
</ol>
<p><img alt="dropbear_5" src="../../../../_images/dropbear_step.JPG" /></p>
</div>
<div class="section" id="error-4-debugging-a-kernel-module">
<h1>Error 4: Debugging a Kernel Module<a class="headerlink" href="#error-4-debugging-a-kernel-module" title="Permalink to this headline">¶</a></h1>
<p>This section uses an example to demonstrate how to debug kernel modules easily using the Vitis IDE. It focuses on the lightweight Linux kernel module <code class="docutils literal notranslate"><span class="pre">lkm_demo1</span></code>. First, you need to complete the steps explained in <a class="reference external" href="#setting-up-the-os-aware-debug-session">Setting Up the OS Aware Debug Session</a>. You also need to ensure that you have PetaLinux set up as described in <a class="reference external" href="#getting-started">Getting Started</a>.</p>
<ol>
<li><p>Run the command <code class="docutils literal notranslate"><span class="pre">petalinux-create</span> <span class="pre">-t</span> <span class="pre">modules</span> <span class="pre">--name</span> <span class="pre">lkm-demo1</span> <span class="pre">--enable</span></code>.</p></li>
<li><p>By default, the PetaLinux tools remove all the build artifacts after the build is completed successfully. To debug the kernel modules, the symbol and object files are required. You can retain the workspace for the Linux kernel and out-of-tree modules by adding the following variable to the <code class="docutils literal notranslate"><span class="pre">petalinuxbsp.conf</span></code> file at the end:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ vi ./project-spec/meta-user/conf/petalinuxbsp.conf

RM_WORK_EXCLUDE += &quot;lkm-demo1&quot;
</pre></div>
</div>
</li>
<li><p>Replace the file <code class="docutils literal notranslate"><span class="pre">./project-spec/meta-user/recipes-modules/lkm-demo1/files/lkm-demo1.c</span></code> with the one available in the <code class="docutils literal notranslate"><span class="pre">src</span></code> folder.</p></li>
<li><p>The folder where the artifacts for <code class="docutils literal notranslate"><span class="pre">lkm-demo1</span></code> should be available is <code class="docutils literal notranslate"><span class="pre">&lt;petalinux_proj_path&gt;/build/tmp/work/zynqmp_generic-xilinx-linux/lkm-demo1/1.0-r0/</span></code>.</p></li>
<li><p>Run the command <code class="docutils literal notranslate"><span class="pre">petalinux-build</span></code>.</p></li>
<li><p>Generate the <code class="docutils literal notranslate"><span class="pre">BOOT.BIN</span></code> and copy it over to the SD card along with <code class="docutils literal notranslate"><span class="pre">image.ub</span></code> and <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code>.</p></li>
<li><p>Boot the board type the command <code class="docutils literal notranslate"><span class="pre">insmod</span> <span class="pre">/lib/modules/5.10.0-xilinx-v2021.1/extra/lkm-demo1.ko</span></code>. The module will crash as shown below.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@xilinx-zcu102-2021_1:~# insmod /lib/modules/5.10.0-xilinx-v2021.1/extra/lkm-demo1.ko 
[   90.899879] &lt;1&gt;Hello module world.
[   90.903310] Organized Panic!......
[   90.906725] Unable to handle kernel NULL pointer dereference at virtual address 0000000000000000
[   90.915505] Mem abort info:
[   90.918297]   ESR = 0x96000046
[   90.921340]   EC = 0x25: DABT (current EL), IL = 32 bits
[   90.926649]   SET = 0, FnV = 0
[   90.929698]   EA = 0, S1PTW = 0
[   90.932837] Data abort info:
[   90.935709]   ISV = 0, ISS = 0x00000046
[   90.939539]   CM = 0, WnR = 1
[   90.942500] user pgtable: 4k pages, 48-bit VAs, pgdp=0000000805206000
[   90.948934] [0000000000000000] pgd=000000080664e003, p4d=000000080664e003, pud=0000000805cf1003, pmd=0000000000000000
[   90.959554] Internal error: Oops: 96000046 [#1] SMP
[   90.964422] Modules linked in: lkm_demo1(O+) zocl(O) uio_pdrv_genirq
[   90.970782] CPU: 1 PID: 814 Comm: insmod Tainted: G           O      5.10.0-xilinx-v2021.1 #1
[   90.979295] Hardware name: ZynqMP ZCU102 Rev1.0 (DT)
[   90.984252] pstate: 60000005 (nZCv daif -PAN -UAO -TCO BTYPE=--)
[   90.990256] pc : lkm_demo1_init+0x38/0x1000 [lkm_demo1]
[   90.995478] lr : lkm_demo1_init+0x28/0x1000 [lkm_demo1]
[   91.000691] sp : ffff80001429bb10
[   91.003997] x29: ffff80001429bb10 x28: 0000000000000013 
[   91.009302] x27: 0000000000000100 x26: ffff800008ddd280 
[   91.014606] x25: ffff8000100ecf80 x24: 0000000000000003 
[   91.019910] x23: 0000000000000000 x22: ffff000800344080 
[   91.025214] x21: ffff800008de0000 x20: ffff000800344080 
[   91.030518] x19: ffff800008ddd000 x18: 0000000000000030 
[   91.035822] x17: 0000000000000000 x16: 0000000000000000 
[   91.041126] x15: ffff000800344498 x14: 0720072007200720 
[   91.046430] x13: ffff8000113c3de0 x12: 000000000000053d 
[   91.051734] x11: 00000000000001bf x10: ffff8000113efde0 
[   91.057038] x9 : 00000000fffff800 x8 : ffff8000113c3de0 
[   91.062342] x7 : ffff8000113efde0 x6 : 0000000000000000 
[   91.067646] x5 : 0000000000005ff4 x4 : 0000000000000000 
[   91.072950] x3 : 0000000000000000 x2 : 0000000000000000 
[   91.078254] x1 : ffff800008ddd000 x0 : ffff800008ddc000 
[   91.083558] Call trace:
[   91.086001]  lkm_demo1_init+0x38/0x1000 [lkm_demo1]
[   91.090873]  do_one_initcall+0x54/0x1bc
[   91.094699]  do_init_module+0x54/0x240
[   91.098438]  load_module+0x1ec8/0x2500
[   91.102180]  __do_sys_finit_module+0xb8/0xfc
[   91.106442]  __arm64_sys_finit_module+0x24/0x30
[   91.110967]  el0_svc_common.constprop.0+0x94/0x1c0
[   91.115750]  do_el0_svc+0x44/0xb0
[   91.119057]  el0_svc+0x14/0x20
[   91.122102]  el0_sync_handler+0x1a4/0x1b0
[   91.126104]  el0_sync+0x174/0x180
[   91.129415] Code: d2800002 b0ffffe1 91000033 90ffffe0 (b900005f) 
[   91.135499] ---[ end trace a492e574dceee8f8 ]---
Segmentation fault
</pre></div>
</div>
<p>You can now use Vitis OS aware debug to check what has gone wrong in the kernel module. To do that, power cycle the board and relaunch the Linux kernel on the target board. Do not insert the module. Set up the Linux OS aware debug by following the steps explained in <a class="reference external" href="#setting-up-the-os-aware-debug-session">Setting Up the OS Aware Debug Session</a>. When the OS aware debug view is ready, work through the following steps.</p>
<ol>
<li><p>Open <strong>Debug &gt; Debug Configurations</strong> and go to the <strong>Path Map</strong> tab.</p>
<p><img alt="path_map_empty" src="../../../../_images/path_map_empty.JPG" /></p>
</li>
<li><p>Click <strong>Add</strong> and provide the link to the artifacts of the <code class="docutils literal notranslate"><span class="pre">lkm-demo1.ko</span></code> file (<code class="docutils literal notranslate"><span class="pre">&lt;petalinux_proj_path&gt;/build/tmp/work/zynqmp_generic-xilinx-linux/lkm-demo1/1.0-r0/lkm-demo1.ko</span></code>).</p>
<p><img alt="pathmap_filled" src="../../../../_images/pathmap_filled.JPG" /></p>
</li>
<li><p>Apply and click <strong>Debug</strong>.</p></li>
<li><p>Debug session will get launched. If in case the Linux processes are not seen, then set the <code class="docutils literal notranslate"><span class="pre">vmlinux</span></code> file as mentioned in the Getting Started section.</p></li>
<li><p>Go to the <strong>Breakpoints</strong> tab and add a C/C++ function breakpoint at the function <code class="docutils literal notranslate"><span class="pre">lkm_demo1_init</span></code> (this is the module init function).</p>
<p><img alt="function_brkpoint" src="../../../../_images/function_brkpoint.JPG" /></p>
<p><img alt="bkrpoint_set" src="../../../../_images/bkrpoint_set.JPG" /></p>
</li>
<li><p>Browse over to the Linux kernel prompt and run <code class="docutils literal notranslate"><span class="pre">insmod</span> <span class="pre">/lib/modules/5.10.0-xilinx-v2021.1/extra/lkm-demo1.ko</span></code>.</p></li>
<li><p>Wait for the breakpoint to be hit in the Vitis IDE.</p>
<p><img alt="breakpoint_hit" src="../../../../_images/breakpoint_hit.JPG" /></p>
</li>
<li><p>Look for the source files using the Locate Files option. The file should be available at <code class="docutils literal notranslate"><span class="pre">&lt;petalinux_proj_path&gt;/build/tmp/work/zynqmp_generic-xilinx-linux/lkm-demo1/1.0-r0/lkm_demo1.c</span></code>.</p></li>
<li><p>Step over the code and you will see the problem:</p>
<p><img alt="error_in_lkm" src="../../../../_images/error_in_lkm.JPG" /></p>
<p>In parallel, you can see the <code class="docutils literal notranslate"><span class="pre">printks</span></code> on the Linux terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@xilinx-zcu102-2021_1:~# insmod /lib/modules/5.10.0-xilinx-v2021.1/extra/lkm-demo1.ko 
[   67.665105] &lt;1&gt;Hello module world.
[   67.668523] Organized Panic!......
</pre></div>
</div>
<p>Refer to line 166, where there is a NULL pointer dereference which is causing the segmentation fault.</p>
</li>
<li><p>Make the changes in the <code class="docutils literal notranslate"><span class="pre">lkm_demo1.c</span></code> file and rebuild the image. You can now fix the kernel module crash issue and debug it.</p></li>
</ol>
</div>
<div class="section" id="error-5-debug-using-qemu">
<h1>Error 5: Debug Using QEMU<a class="headerlink" href="#error-5-debug-using-qemu" title="Permalink to this headline">¶</a></h1>
<p>Repeat the steps from <a class="reference external" href="/docs/2-debugging-bare-metal-applications">Debugging Bare-Metal Applications</a> but this time using QEMU. To launch debug using QEMU, refer to <a class="reference external" href="https://www.xilinx.com/html_docs/xilinx2021_1/vitis_doc/debugappproj.html#pqw1565072996942">Standalone Application Debug Using System Debugger on QEMU</a>.</p>
</div>
<div class="section" id="further-reading">
<h1>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h1>
<div class="section" id="attaching-an-application-to-system-debugger">
<h2>Attaching an Application to System Debugger<a class="headerlink" href="#attaching-an-application-to-system-debugger" title="Permalink to this headline">¶</a></h2>
<p>Refer to <a class="reference external" href="https://www.xilinx.com/html_docs/xilinx2021_1/vitis_doc/debugappproj.html#jlr1565072996727">Attach and Debug using Xilinx System Debugger</a> for more information.</p>
</div>
<div class="section" id="path-mapping">
<h2>Path Mapping<a class="headerlink" href="#path-mapping" title="Permalink to this headline">¶</a></h2>
<p>When an application is compiled with debug flags (for example, <code class="docutils literal notranslate"><span class="pre">-O0</span> <span class="pre">-g</span></code>), the compiler stores references to the source paths in the debug sections of the ELFs. This information is used by the debugger to map the PC address of the target processor to the source line in the code. Path mapping allows you to debug an application when its sources are not available at the location where it was compiled. For example, you can compile an application on Windows and debug it on Linux, or debug a pre-built Linux kernel image, without having to recompile the sources. In both cases, you can download and run the images using <a class="reference external" href="https://www.xilinx.com/html_docs/xilinx2021_1/vitis_doc/XSCT.html#mpr1543754624906">XSCT</a>, and then attach the debugger.</p>
<p>After this is done, the debugger should issue a warning about the missing source files when the processor is stopped. You can then enable path mapping in one of the following ways, so that the debugger can find the sources from a different location.</p>
<p><strong>Note:</strong> The source files at the new location should exactly match the source files at the original location.</p>
<ol class="simple">
<li><p>Click <strong>Edit source lookup path</strong>.</p></li>
<li><p>Right-click <strong>Debug Configuration</strong> and select <strong>Path Mapping</strong>.</p></li>
<li><p>Select <strong>Add Path Mapping</strong>.</p></li>
<li><p>Enter the compilation path as the source path. Enter the new location where the sources are available as the destination path. For example, if the application was compiled at <code class="docutils literal notranslate"><span class="pre">C:\testapp</span></code>, and the same sources are available at <code class="docutils literal notranslate"><span class="pre">/scratch/source</span></code>, the source path would be <code class="docutils literal notranslate"><span class="pre">C:\testapp</span></code>, and the destination path would be <code class="docutils literal notranslate"><span class="pre">/scratch/source</span></code>.</p></li>
<li><p>Save the settings by clicking <strong>OK</strong>. The debugger now shows the source files from the new path.</p></li>
</ol>
</div>
<div class="section" id="using-remote-host">
<h2>Using Remote Host<a class="headerlink" href="#using-remote-host" title="Permalink to this headline">¶</a></h2>
<p>Refer to <a class="reference external" href="https://www.xilinx.com/html_docs/xilinx2021_1/vitis_doc/debugappproj.html#hwl1565072997080__cr294539">Using a Remote Host with System Debugger</a> for more information.</p>
</div>
<div class="section" id="basic-setup-for-os-aware-debug">
<h2>Basic Setup for OS Aware Debug<a class="headerlink" href="#basic-setup-for-os-aware-debug" title="Permalink to this headline">¶</a></h2>
<p>These steps are required if you are <em>not</em> using the Xilinx provided BSP. The kernel must be built with the following steps for OS aware debug to work.</p>
<ol>
<li><p>Enable kernel debug and debug info in the kernel menuconfig:</p>
<ul>
<li><p>Type <code class="docutils literal notranslate"><span class="pre">petalinux-config</span> <span class="pre">-c</span> <span class="pre">kernel</span></code>.</p></li>
<li><p>Go to <strong>Kernel hacking</strong>.</p>
<p><img alt="osa_1" src="../../../../_images/kernel_hack.png" /></p>
</li>
<li><p>Make sure that kernel debugging is enabled.</p>
<p><img alt="osa_2" src="../../../../_images/kernel_debug.png" /></p>
</li>
<li><p>Go to <strong>Compile-time checks and compiler options</strong>.</p>
<p><img alt="osa_3" src="../../../../_images/compile_time.png" /></p>
</li>
<li><p>Make sure that <strong>Compile the kernel with debug info</strong> is enabled.</p>
<p><img alt="osa_4" src="../../../../_images/debug_info.png" /></p>
</li>
</ul>
</li>
<li><p>Disable CPU idle power management:</p>
<ul class="simple">
<li><p>Go to CPU power management and disable CPU idle PM support (only for Zynq UltraScale+ MPSoC).</p></li>
<li><p>Save the configuration and exit.</p></li>
<li><p>When the exit is completed, press <strong>enter</strong>.</p></li>
</ul>
</li>
<li><p>Run the PetaLinux build using the <code class="docutils literal notranslate"><span class="pre">petalinux-build</span></code> command.</p>
<ul class="simple">
<li><p>Copy over the <code class="docutils literal notranslate"><span class="pre">BOOT.BIN</span></code>, <code class="docutils literal notranslate"><span class="pre">image.ub</span></code>, and <code class="docutils literal notranslate"><span class="pre">boot.scr</span></code> from the <code class="docutils literal notranslate"><span class="pre">linux/images/</span></code> folder to the SD card.</p></li>
<li><p>Boot the board.</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="os-awareness-osa-options-in-the-vitis-ide">
<h2>OS Awareness (OSA) Options in the Vitis IDE<a class="headerlink" href="#os-awareness-osa-options-in-the-vitis-ide" title="Permalink to this headline">¶</a></h2>
<p>Refer to <a class="reference external" href="https://www.xilinx.com/html_docs/xilinx2021_1/vitis_doc/debugappproj.html#itw1565072997401">Enabling OS Aware Debug</a>.</p>
<p><img alt="osa_menu" src="../../../../_images/osa_menu.PNG" /></p>
<p><em>Copyright 2021 Xilinx Inc. Licensed under the Apache License, Version 2.0 (the “License”); you may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0. Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</em></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>

        </div>
      </div>


	  <!-- Sphinx Page Footer block -->
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../5-summary/README.html" class="btn btn-neutral float-right" title="Summary" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../3-debugging-linux-applications/README.html" class="btn btn-neutral float-left" title="Debugging Linux Applications" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p class="footerinfo">
      <span class="lastupdated">
        Last updated on May 20, 2022.
      </span>

    </p>
	<br>
  </div>
      </div>
    </section>


  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

   <script type="text/javascript">
    jQuery(function() { Search.loadIndex("searchindex.js"); });
  </script>

  <script type="text/javascript" id="searchindexloader"></script>


  
  
    
  



  <!--  Xilinx template footer block -->
							</div>
						</div>
					</div>
				</div>
				<div class="xilinxExperienceFragments experiencefragment aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
					<div class="xf-content-height">
						<div class="aem-Grid aem-Grid--16 aem-Grid--default--16 ">
							<div class="footer parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16">
								<noindex>
                  <!-- make footer fixed - NileshP -->
                  <style>
                        .footer {
                        position: fixed;
                        left: 0;
                        bottom: 0;
                        width: 100%;
                        }
                  </style>
                  <!-- make footer fixed NileshP-->
									<footer>
										<div class="aem-Grid aem-Grid--16">
											<div class="aem-GridColumn aem-GridColumn--xxxlarge--none aem-GridColumn--xsmall--16 aem-GridColumn--offset--xsmall--0 aem-GridColumn--xlarge--none aem-GridColumn--xxlarge--none aem-GridColumn--default--none aem-GridColumn--offset--large--1 aem-GridColumn--xlarge--12 aem-GridColumn--offset--default--0 aem-GridColumn--xxlarge--10 aem-GridColumn--offset--xlarge--2 aem-GridColumn--offset--xxlarge--3 aem-GridColumn--offset--xxxlarge--4 aem-GridColumn--xsmall--none aem-GridColumn--large--none aem-GridColumn aem-GridColumn--large--14 aem-GridColumn--xxxlarge--8 aem-GridColumn--default--16">
												<div class="container-fluid sub-footer">
													<div class="row">
														<div class="footerSocial parbase">
														
															<div class="col-md-push-6 col-lg-push-6 col-md-6 col-lg-6">
																<div class="lang-select dropup hidden-md hidden-lg">
		<button data-toggle="dropdown">
			<span class="fas fa-globe" aria-hidden="true"></span>
			<span>
				
					English
				</span>
		<span class="far fa-angle-down" aria-hidden="true"></span>
	</button>
	<ul class="dropdown-menu">
		<li>
				<a href="https://japan.xilinx.com/" target="_self">
					日本語
				</a>
			</li>
		<li>
				<a href="https://china.xilinx.com/" target="_self">
					简体中文
				</a>
			</li>
		</ul>
	</div>
																<ul class="list-inline pull-right social-menu">
																	<li>
																		<a href="https://www.linkedin.com/company/xilinx">
																		<span class="linkedin icon"></span>
																		<span class="sr-only">Connect on LinkedIn</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.twitter.com/XilinxInc">
																		<span class="twitter icon"></span>
																		<span class="sr-only">Follow us on Twitter</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.facebook.com/XilinxInc">
																		<span class="facebook icon"></span>
																		<span class="sr-only">Connect on Facebook</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.youtube.com/XilinxInc">
																		<span class="youtube icon"></span>
																		<span class="sr-only">Watch us on YouTube</span>
																		</a>
																	</li>
																	<li>
																		<a href="https://www.xilinx.com/registration/subscriber-signup.html">
																		<span class="newsletter icon"></span>
																		<span class="sr-only">Subscribe to Newsletter</span>
																		</a>
																	</li>
																</ul>
																	<div class="lang-select dropup hidden-xs hidden-sm">
	<button data-toggle="dropdown">
		<span class="fas fa-globe" aria-hidden="true"></span>
		<span>
			
				English
			</span>
		<span class="far fa-angle-down" aria-hidden="true"></span>
	</button>
	<ul class="dropdown-menu">
		<li>
				<a href="https://japan.xilinx.com/" target="_self">
					日本語
				</a>
			</li>
		<li>
				<a href="https://china.xilinx.com/" target="_self">
					简体中文
				</a>
			</li>
		</ul>
	</div>
															</div>
														</div>
														<div class="col-md-pull-5 col-lg-pull-5 col-md-5 col-lg-5">
															<span class="copyright">©2021 Advanced Micro Devices, Inc</span>
														</div>

													</div>
													                    <div class="movethisrowtoleft row">
                        <div class="col-xs-24">
                            <ul class="sub-menu">
                                <li><a href="https://www.amd.com/en/corporate/copyright">Terms and Conditions</a></li>
                                <li><a href="https://www.amd.com/en/corporate/privacy">Privacy</a></li>
                                <li><a href="https://www.amd.com/en/corporate/cookies">Cookie Policy</a></li>
                                <li><a href="https://www.amd.com/en/corporate/trademarks">Trademarks</a></li>
                                <li><a href="https://www.amd.com/system/files/documents/statement-human-trafficking-forced-labor.pdf">Statement on Forced Labor</a></li>
                                <li><a href="https://www.amd.com/en/corporate/competition">Fair and Open Competition</a></li>
                                <li><a href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf">UK Tax Strategy</a></li>
                                <li><a href="#cookiessettings" class="ot-sdk-show-settings">Cookies Settings</a></li>
                            </ul>
                        </div>
                    </div>
												</div>
											</div>
										</div>
									</footer>
								</noindex>
							</div>
						</div>
					</div>
				</div>
<div class="backToTop parbase aem-GridColumn--default--none aem-GridColumn aem-GridColumn--offset--default--0 aem-GridColumn--default--16"><noindex>
    <span data-component="backToTopButton" class="backToTopButton loaded">
        <ul>
            <li>
                <a href="https://www.author.xilinx.com/xx/rebrand/amd/en-amd-xilinx-header-footer.html#top" class="btn top">
                    <span class="fas fa-angle-up" aria-hidden="true"></span>
                </a>
            </li>
        </ul>
    </span>
</noindex></div>
			</div>
		</div>


		<script>window.CQ = window.CQ || {}</script>
		<script src="https://static.cloud.coveo.com/searchui/v2.4382/js/CoveoJsSearch.Lazy.min.js"></script>
		<script>
			var underscoreSetup = function () {
			  _.templateSettings.interpolate = /\{\{=([^-][\S\s]+?)\}\}/g;
			  _.templateSettings.evaluate = /\{\{([^-=][\S\s]+?)\}\}/g;
			  _.templateSettings.escape = /\{\{-([^=][\S\s]+?)\}\}/g;
			}

			underscoreSetup();
		</script>
	</body>
</html>